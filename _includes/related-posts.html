<!-- Related Posts
================================================== -->
<div class="{% unless page.categories == empty %} related-posts {% endunless %}">  

  {% unless page.categories == empty %}
  <h2 class="text-center mb-4">Explore more like this</h2>
  {% endunless %}
  
  <div class="d-flex justify-content-center align-items-center">

  <!-- Categories -->
  {% assign sortedCategories = page.categories | sort %}
  {% for category in sortedCategories %}
    <a class="smoothscroll badge badge-primary text-capitalize" href="{{site.baseurl}}/{% if page.lang == 'en' %}en/{% endif %}categories#{{ category | replace: " ","-" }}">{{ category }}</a>                
  {% endfor %}

  <!-- Tags -->  
  {% assign sortedTags = page.tags | sort %}
  {% for tag in sortedTags %}                
    <a class="smoothscroll badge badge-primary text-capitalize" href="{{site.baseurl}}/{% if page.lang == 'en' %}en/{% endif %}tags#{{ tag | replace: " ","-" }}">{{ tag }}</a>               
  {% endfor %}

  </div>

  {% assign maxRelated = 12 %}
  {% assign minCommonTags = 2 %}
  {% assign maxRelatedCounter = 0 %}
  {% assign current_lang = page.lang | default: "ja" %}

  <div class="blog-grid-container">

  {% for post in site.posts %}
    {% if post.url != page.url and post.lang == current_lang %}  {% comment %} ★ 言語を一致させる {% endcomment %}

      {% assign sameTagCount = 0 %}
      {% assign commonTags = '' %}

      {% for tag in post.tags %}
        {% if page.tags contains tag %}
          {% assign sameTagCount = sameTagCount | plus: 1 %}
          {% capture tagmarkup %} {{ tag }} {% endcapture %}
          {% assign commonTags = commonTags | append: tagmarkup %}
        {% endif %}
      {% endfor %}

      {% if sameTagCount >= minCommonTags %}
        {% include postbox.html %}
        {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% if maxRelatedCounter >= maxRelated %}
          {% break %}
        {% endif %}
      {% endif %}

    {% endif %}
  {% endfor %}

  </div>        
</div>
