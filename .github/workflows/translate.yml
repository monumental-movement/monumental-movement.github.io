import os
import re
from deep_translator import GoogleTranslator

SRC_DIR = "_posts"
DEST_DIR = "en/_posts"

translator = GoogleTranslator(source="ja", target="en")
os.makedirs(DEST_DIR, exist_ok=True)

print("ğŸŒ Starting safe translation (preserve YAML)...")

for filename in os.listdir(SRC_DIR):
    if not filename.endswith(".md"):
        continue

    src_path = os.path.join(SRC_DIR, filename)
    dest_path = os.path.join(DEST_DIR, filename)

    with open(src_path, "r", encoding="utf-8") as f:
        content = f.read()

    # --- YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼åˆ†é›¢ ---
    if content.startswith("---"):
        parts = re.split(r"^---\s*$", content, flags=re.MULTILINE)
        if len(parts) >= 3:
            front_matter = parts[1].strip()
            body = parts[2].strip()
        else:
            front_matter = ""
            body = content
    else:
        front_matter = ""
        body = content

    # --- è‹±è¨³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå®‰å…¨ãƒ¢ãƒ¼ãƒ‰ï¼‰ ---
    if os.path.exists(dest_path):
        print(f"â© Skipping (exists): {filename}")
        continue

    print(f"ğŸŒ Translating: {filename}")

    try:
        translated_body = translator.translate(body)
    except Exception as e:
        print(f"âš ï¸ Translation failed for {filename}: {e}")
        continue

    # --- YAMLãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã‚’ä¿æŒ ---
    translated_content = f"---\n{front_matter}\nlang: en\n---\n\n{translated_body}\n"

    with open(dest_path, "w", encoding="utf-8") as f:
        f.write(translated_content)

    print(f"âœ… Saved: {dest_path}")

print("\nğŸ‰ Translation complete (YAML preserved safely)")
